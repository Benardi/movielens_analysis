---
title: "Analysis on MovieLens dataset"
date: 10/07/2018
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(resample)
library(boot)

theme_set(theme_bw())
```

```{r, warning=FALSE}
readr::read_csv(here::here("data/movies.csv"),
                progress = FALSE,
                col_types = cols(
                      movieId = col_integer(),
                      title = col_character(),
                      genres = col_character()
                    )) %>% 
  group_by(movieId) %>%
  mutate(year = as.numeric(sub("\\).*", "",sub(".*\\(", "", title))),
         num_genres = length(as.list(strsplit(genres,'|',fixed = TRUE))[[1]]),
         homogeneous = num_genres == 1) %>% 
  na.omit() %>%
  ungroup() -> movies

readr::read_csv(here::here("data/ratings.csv"),
                progress = FALSE,
                col_types = cols(
                userId = col_integer(),
                movieId = col_integer(),
                rating = col_double(),
                timestamp = col_integer()
                )) %>%
  na.omit() -> ratings

dplyr::inner_join(
  movies,
  ratings,
  by="movieId") -> data

data %>%
  glimpse()

```

```{r}
movies %>%
  filter(title == "Hamlet (2000)")

data %>%
  filter(movieId != 3598) -> data
```

* Looks like Hamlet was included twice and as Hamlet is clearly a Drama we're gonna remove the entrys that say otherwise

```{r}
data %>%
  group_by(movieId) %>%
  slice(1) %>%
  ggplot(aes(year)) +
  geom_bar()
```

```{r}
data %>%
  ggplot(aes(num_genres)) +
  geom_bar()
```

```{r}
data %>%
  ggplot(aes(homogeneous,rating)) +
  geom_violin() 
```

```{r}
b.diff.means <- bootstrap2(data$rating, 
                          treatment = data$homogeneous, 
                          mean, 
                          R = 10000)

means.diff = CI.percentile(b.diff.means, probs = c(.025, .975))
means.diff
```

```{r}
data.frame(means.diff) %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```


* Heterogenous movies (movies with more than one genre) are significantly better rated than the Homogenous movies (movies with only one genre)

* The difference in ratings although undeniable is very small in  practical terms

```{r}
b.diff.deviation <- bootstrap2(data$rating, 
                          treatment = data$homogeneous, 
                          sd,
                          R = 10000)

deviation.diff = CI.percentile(b.diff.deviation, probs = c(.025, .975))
deviation.diff
```

```{r}
data.frame(deviation.diff) %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```

* There's no significant difference in terms of dispersion  between the ratings of Heterogeneous and Homogeneous movies.

```{r}
# data %>%
#   group_by(movieId,
#            title,
#            year,
#            num_genres,
#            homogeneous) %>%
#   summarise(median_rating = median(rating),
#             well_rated = median_rating > 3.5) -> data
```

```{r}
data %>% 
  filter(homogeneous) -> temp

meu_theta <- function(x, i) {
    x %>% 
        slice(i) -> d
    fit = lm(rating ~ genres, data=d)
    return(summary(fit)$r.square)
}

res.boot <- boot(data = temp, 
                 statistic = meu_theta, 
                 R = 2000)

plot(res.boot)
boot.ci(boot.out = res.boot, 
        conf = 0.95, 
        type = "basic")
```


