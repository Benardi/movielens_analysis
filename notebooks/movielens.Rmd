---
title: "Analysis on MovieLens dataset"
date: 14/07/2018
author: JosÃ© Benardi de Souza Nunes
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(resample)
library(boot)

theme_set(theme_bw())
```

# Prepare and Overview Data

```{r, warning=FALSE}
readr::read_csv(here::here("data/movies.csv"),
                progress = FALSE,
                col_types = cols(
                      movieId = col_integer(),
                      title = col_character(),
                      genres = col_character()
                    )) %>% 
  group_by(movieId) %>%
  mutate(year = as.numeric(sub("\\).*", "",sub(".*\\(", "", title))),
         num_genres = length(as.list(strsplit(genres,'|',fixed = TRUE))[[1]]),
         homogeneous = num_genres == 1) %>%  # Deriving homogeneity
  na.omit() %>%
  ungroup() -> movies

readr::read_csv(here::here("data/ratings.csv"),
                progress = FALSE,
                col_types = cols(
                userId = col_integer(),
                movieId = col_integer(),
                rating = col_double(),
                timestamp = col_integer()
                )) %>%
  na.omit() -> ratings
```

```{r}
dplyr::inner_join(
  movies,
  ratings,
  by="movieId") -> data


data %>%
  group_by(movieId) %>%
  summarise(median_rating = median(rating), # Deriving whether a movies is well rated
            well_rated = median_rating > 3.5) -> summarised


dplyr::inner_join(
  summarised,
  data,
  by="movieId") -> data

data %>%
  glimpse()
```

```{r}
movies %>%
  filter(title == "Hamlet (2000)")

data %>%
  filter(movieId != 3598) -> data
```

* Looks like Hamlet was included twice and as Hamlet is clearly a Drama we're gonna remove the entries that say otherwise

```{r}
data %>%
  group_by(movieId) %>%
  summarise(median_rating = median(rating),
            well_rated = median_rating > 3.5) -> summarised


dplyr::inner_join(
  summarised,
  data,
  by="movieId") -> data
```




```{r}
data %>%
  group_by(movieId) %>%
  slice(1) %>%
  ggplot(aes(year)) +
  geom_bar() +
  labs(x="Movie Year",
       y="Absolute Frequency")
```

* There's a whole lot of movies from the 2000's
* There's movies going as far as the first decade of the 1900's

```{r}
data %>%
  ggplot(aes(num_genres)) +
  geom_bar() +
  labs(x="Number of Genres",
       y="Absolute Frequency")
```

* Most movies have around 2 or 3 genres.

```{r}
data %>%
  ggplot(aes(rating,y=..prop..)) +
  geom_bar() +
  labs(x="Movie Rating", 
       y="Relative Frequency")
```

* There's a lot of generous reviews, with 4 stars composing almost 30% of the ratings. 

<br>

***

<br>

# Homogeneity in Genre

<br>

* A movie will be considered homogeneneous in terms of genre if the movie is classified under a single genre. Therefore, any movie with more than one genre will not be considered homogeneus in terms of genre.

## Data Sample Preview

```{r}
data %>%
  ggplot(aes(homogeneous,rating)) +
  geom_violin() +
  labs(x="Homogeneous in Genre ",
       y="Movie Rating")
```

* There's in fact indication of a difference on what the average rating of the two groups would be. The Heterogeneous movies seem to have more higher ratings in terms of sample.
* In terms of dispersion the ratings seem to be similarly distributed across both groups in terms of sample.

```{r}
data %>%
  ggplot(aes(homogeneous,year)) +
  geom_violin() +
  labs(x="Homogeneous in Genre ",
       y="Year of the movie")
```

* The Homogeneous group seems to have more movies around the 1980s
* The Heterogenous group has the oldest movies. 

## Is the average rating affected by genre homogeneity?

<br>

* We will use as estimator the median rating (TRUE - FALSE) unpaired, **the median rating of the well rated minus the median rating of those not well rated**

```{r}
b.diff.means <- bootstrap2(data$rating, 
                          treatment = data$homogeneous, 
                          mean, 
                          R = 10000)

means.diff = CI.percentile(b.diff.means, probs = c(.025, .975))
means.diff
```

```{r}
data.frame(means.diff) %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```


* Heterogenous movies (movies with more than one genre) are significantly better rated than the Homogenous movies (movies with only one genre)

* The difference in ratings although undeniable is very small in  practical terms

## Is the rating's dispersion affected by homogeneity in genre?

<br>

* We will use as estimator the standard deviation (TRUE - FALSE) unpaired, **the rating's standard deviation of the homogeneous (in genre) minus the rating's standard deviation of the heterogeneous (in genre)**.

```{r}
b.diff.deviation <- bootstrap2(data$rating, 
                          treatment = data$homogeneous, 
                          sd,
                          R = 10000)

deviation.diff = CI.percentile(b.diff.deviation, probs = c(.025, .975))
deviation.diff
```

```{r}
data.frame(deviation.diff) %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```

* There's no significant difference in terms of dispersion  between the ratings of Heterogeneous and Homogeneous movies.

<br>

***

<br>

# Is the movie well rated

* Where our analysis regards impact of genre we shall only consider the movies homogeneous in terms of genre, we do so to have a clearer idea of the effect of the different genres.

* Movies are considered well rated when they have been rated above 3.5 stars in terms of median.

```{r}
data %>% 
  filter(homogeneous) %>%
  mutate(genres = as.factor(genres)) -> data_homogen
```

## Data Sample Preview

```{r}
data_homogen %>%
  ggplot(aes("",rating,
             group=well_rated,
             color=well_rated)) +
  geom_count(position = position_dodge(width = 0.5)) + 
  coord_flip() + 
  labs(y="Movie Rating",x="") +
    theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  scale_size(range = c(1,15)) 
```

* Whether the movie is well rated seems to have an impact on how the ratings are distributed, whether it has a significant impact remains to be seen

```{r}
data_homogen %>%
  ggplot(aes(genres,rating,
             group=genres,
             color=well_rated)) +
  geom_count() + 
  coord_flip() + 
  facet_grid(~ well_rated) +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank()) +
  labs(y="Movie Rating", x="Movie Genre")
```

* The impact of the genre itself apparently remains similar across movies that were well rated and movies that were not, the aforementioned in terms of sample.

<br>

## Is the impact of the genre on the ratings affected by whether the movie is well rated?

<br>

* We will use as estimator the R^2^ of the genre against the ratings (TRUE - FALSE) unpaired, **the R^2^ of the well rated minus the R^2^ of those not well rated**.
* The R^2^ in this case represent how much of the variation in the ratings can be explained by the genre.

```{r}
meu_theta <- function(x, i) {
    x %>% 
        slice(i) %>% 
    filter(well_rated) -> d1
    x %>% 
        slice(i) %>% 
    filter(!well_rated) -> d2
      
    fit1 = lm(rating ~ genres, data=d1)
    fit2 = lm(rating ~ genres, data=d2)
    return(summary(fit1)$r.square - summary(fit2)$r.square)
}

res.boot <- boot(data = data_homogen, 
                 statistic = meu_theta, 
                 R = 2000)
result_r2 <- boot.ci(boot.out = res.boot, 
        conf = 0.95, 
        type = "basic")
result_r2
```

```{r}
X2.5. = c(result_r2$basic[4])
X97.5. = c(result_r2$basic[5])
r2.diff = data.frame(X2.5.,X97.5.)

r2.diff %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```

* There's no evidence of a significant difference on how much the genre impacts the ratings when we put side by side the movies whom were well rated and the ones whom weren't.
* This is in accordance to what we previewed in the sample.

<br>

## Is the rating's dispersion affected by whether the movie is well rated?

<br>

* We will use as estimator the standard deviation (TRUE - FALSE) unpaired, **the rating's standard deviation of the well rated minus the rating's standard deviation of those not well rated**

```{r}
meu_theta <- function(x, i) {
    x %>% 
        slice(i) %>% 
        group_by(well_rated) %>%
        summarise(sd = sd(rating)) -> y
  
    result <- y[y$well_rated == TRUE,]$sd - 
              y[y$well_rated == FALSE,]$sd
    
    return(result)
}

res.boot <- boot(data = data, 
                 statistic = meu_theta, 
                 R = 2000)
result_disprs <- boot.ci(boot.out = res.boot, 
        conf = 0.95, 
        type = "basic")

result_disprs
```


```{r}
X2.5. = c(result_disprs$basic[4])
X97.5. = c(result_disprs$basic[5])
r2.diff = data.frame(X2.5.,X97.5.)

r2.diff %>%
  ggplot(aes(x = "Difference",ymin = X2.5., ymax = X97.5.)) +
  geom_errorbar(width = .2) +
  geom_hline(yintercept = 0, colour = "darkorange") +
  labs(x="")
```

* There's indication of a significant difference at 95% of confidence, which indicates that the  not well rated have a higher dispersion of ratings than the well rated.
