---
title: "Hypothesis testing on MovieLens dataset"
date: 14/07/2018
author: José Benardi de Souza Nunes
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(coin)
library(resample)
library(tidyverse)


theme_set(theme_bw())
```

# Data Overview 

```{r, warning=FALSE}
readr::read_csv(here::here("data/movies.csv"),
                progress = FALSE,
                col_types = cols(
                      movieId = col_integer(),
                      title = col_character(),
                      genres = col_character()
                    )) %>% 
  group_by(movieId) %>%
  mutate(year = as.numeric(sub("\\).*", "",sub(".*\\(", "", title))),
         num_genres = length(as.list(strsplit(genres,'|',fixed = TRUE))[[1]]),
         homogeneous = num_genres == 1, # Deriving homogeneity
         xx_century = year <= 2000
         ) %>%  
  na.omit() %>%
  ungroup() -> movies

readr::read_csv(here::here("data/ratings.csv"),
                progress = FALSE,
                col_types = cols(
                userId = col_integer(),
                movieId = col_integer(),
                rating = col_double(),
                timestamp = col_integer()
                )) %>%
  na.omit() -> ratings
```

```{r}
dplyr::inner_join(
  movies,
  ratings,
  by="movieId") -> data


data %>%
  group_by(movieId) %>%
  summarise(median_rating = median(rating), # Deriving whether a movies is well rated
            well_rated = median_rating > 3.5) -> summarised


dplyr::inner_join(
  summarised,
  data,
  by="movieId") -> data

data %>%
  glimpse()
```

```{r}
movies %>%
  filter(title == "Hamlet (2000)")

data %>%
  filter(movieId != 3598) -> data
```

* Looks like Hamlet was included twice. As Hamlet is clearly a Drama we're gonna remove the entries that say otherwise.

<br>

```{r}
data %>%
  group_by(movieId) %>%
  slice(1) %>%
  ggplot(aes(year)) +
  geom_bar() +
  labs(x="Movie Year",
       y="Absolute Frequency")
```

* There's a whole lot of movies from the 2000's.
* There's movies going as far as the first decade of the 1900's.

```{r}
data %>%
  ggplot(aes(num_genres)) +
  geom_bar() +
  labs(x="Number of Genres",
       y="Absolute Frequency")
```

* Most movies have 2 or 3 genres.

```{r}
data %>%
  ggplot(aes(rating,y=..prop..)) +
  geom_bar() +
  labs(x="Movie Rating", 
       y="Relative Frequency")
```

* There's a lot of generous reviews, with 4 stars composing almost 30% of the ratings. 

<br>

***

<br>

# Is the movie well rated

<br>

* Where our analysis regards impact of genre we shall consider only the movies homogeneous in terms of genre, we do so to have a clearer picture of the effect of the different genres.
* Movies are considered well rated when they have been rated above 2.5 stars in terms of median. 

## Is there a difference in the proportion of well rated rated movies when we compare movies from XX and XXI century?

<br>

* We will use as estimator the unpaired difference of the proportion of well rated (TRUE - FALSE):
    + **The proportion of well rated of movies from the XX century minus the proportion of well rated of movies from the XXI century**.
    
Agora vejamos o quão frequente seria encontrarmos uma diferença do tamanho que encontramos se não houvesse associação nenhuma entre qual é o episódio e qual é a avaliação que ele recebe. A situação onde não existe associação é a hipótese nula. Se a diferença que observamos em nossa amostra acontece facilmente na hipótese nula, isso significa que não temos evidência forte de associação: o que observamos acontece também quando não há associação. 

No caso onde a diferença que observamos é improvável na hipótese nula, então observamos algo que é indicativo de associação. Repare que é uma dupla negação: se não acontece associação como a que vimos na amostra na situação onde não há associação, então temos evidência de que há associação. 

## Manual

```{r}
diffs <- replicate(5000, {
  data %>%
  mutate(century_shuffled = sample(xx_century, n())) -> temp
  
  temp %>%
  group_by(century_shuffled) %>%
    filter(well_rated) %>%
    summarise(n = n()) -> y  
  
  temp %>%  
    group_by(century_shuffled) %>%
    summarise(n = n()) -> total 
  
    prop1 <- y[y$century_shuffled == TRUE,]$n / total[total$century_shuffled == TRUE,]$n
    prop2 <- y[y$century_shuffled == FALSE,]$n / total[total$century_shuffled == FALSE,]$n
      
    return(prop1 - prop2)
  })
```


```{r}
data %>%
group_by(xx_century) %>%
  filter(well_rated) %>%
  summarise(n = n()) -> y  

data %>%  
  group_by(xx_century) %>%
  summarise(n = n()) -> total 

  prop1 <- y[y$xx_century == TRUE,]$n / total[total$xx_century == TRUE,]$n
  prop2 <- y[y$xx_century == FALSE,]$n / total[total$xx_century == FALSE,]$n

diff.prop.obsrvd = prop1 - prop2  
print(paste("Observed difference in proportion:",diff.prop.obsrvd))
```


```{r}
diffs <- replicate(5000, {
  data %>%
  mutate(century_shuffled = sample(xx_century, n())) -> temp
  
  temp %>%
  group_by(century_shuffled) %>%
    filter(well_rated) %>%
    summarise(n = n()) -> y  
  
  temp %>%  
    group_by(century_shuffled) %>%
    summarise(n = n()) -> total 
  
    prop1 <- y[y$century_shuffled == TRUE,]$n / total[total$century_shuffled == TRUE,]$n
    prop2 <- y[y$century_shuffled == FALSE,]$n / total[total$century_shuffled == FALSE,]$n
      
    return(prop1 - prop2)
  })

glimpse(diffs)
```

```{r}
tibble(diferenca = diffs) %>% 
  ggplot(aes(x = diferenca)) + 
  geom_histogram(bins = 30, 
                 fill= "grey",
                 color="black") + 
  geom_vline(xintercept = diff.prop.obsrvd) 
```

```{r}
# p-valor
sum(abs(diffs) >= abs(diff.prop.obsrvd)) / length(diffs)
```

## Let's use the resample package

```{r}
permutationTest2(data = data,
                 R=5000,
                 statistic = prop.table(table(well_rated))[2],
                 treatment = xx_century)
```

## Let's use the coin package

```{r}
independence_test(well_rated ~ xx_century, 
                  data = data)
```

